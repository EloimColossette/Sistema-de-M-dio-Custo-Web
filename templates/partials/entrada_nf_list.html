<div id="modal-entradas" class="modal show">
  <div class="modal-content">

    <div class="modal-header">
      <h3>Entradas de NF Cadastradas</h3>
      <span id="fecharModalEntradaBtn" class="close">&times;</span>
    </div>

    <div class="search-and-filter">
      <div class="search-container">
        <input type="text" id="searchEntradaInput" placeholder="üîç Pesquisar NF, Fornecedor‚Ä¶" autocomplete="off" />
        <button type="button" id="searchEntradaBtn" class="btn btn-secondary">üîç</button>
      </div>

      <!-- bot√µes de a√ß√£o: Exportar / Importar -->
      <div class="actions">
        <button id="btnExportEntrada" class="btn btn-sm btn-secondary">Exportar</button>

        <!-- Apenas o bot√£o que abre o modal de import -->
        <button id="btnImportEntrada" class="btn btn-sm btn-secondary" type="button">Importar</button>
      </div>
    </div>

    <div class="modal-body">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllEntradas" /></th>
              <th>Data</th>
              <th>NF</th>
              <th>Fornecedor</th>

              {# Materiais (todos primeiro) #}
              {% for i in range(1, max_materiais + 1) %}
                <th>Material {{ i }}</th>
              {% endfor %}

              {# Colunas fixas entre materiais e valores unit√°rios #}
              <th>Produto</th>
              <th>Custo R$</th>
              <th>IPI %</th>
              <th>Valor Integral</th>

              {# Valores unit√°rios (ap√≥s as colunas fixas) #}
              {% for i in range(1, max_materiais + 1) %}
                <th>Valor Unit. {{ i }}</th>
              {% endfor %}

              {# Duplicatas #}
              {% for j in range(1, max_duplicatas + 1) %}
                <th>Duplicata {{ j }}</th>
              {% endfor %}

              {# √öltimas colunas fixas #}
              <th>Valor Unit. Energia</th>
              <th>Valor M.O.</th>
              <th>Peso Liq.</th>
              <th>Peso Int.</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>

          <tbody>
            {% for e in entradas %}
              <tr>
                <td data-col="select">
                  <input type="checkbox" class="selectEntrada" data-id="{{ e.id }}" />
                </td>
                <td data-col="data">{{ e.data }}</td>
                <td data-col="nf">{{ e.nf }}</td>
                <td data-col="fornecedor">{{ e.fornecedor }}</td>

                {# Materiais 1..N (nome) #}
                {% for i in range(0, max_materiais) %}
                  <td data-col="material_{{ i+1 }}">
                    {% if e.materiais and e.materiais|length > i and e.materiais[i].nome %}
                      {{ e.materiais[i].nome }}
                    {% endif %}
                  </td>
                {% endfor %}

                {# Colunas fixas #}
                <td data-col="produto">{{ e.produto }}</td>
                <td data-col="custo_empresa">{{ e.custo_empresa|money }}</td>
                <td data-col="ipi">{{ e.ipi|percent }}</td>
                <td data-col="valor_integral">{{ e.valor_integral|money }}</td>

                {# Valores unit√°rios 1..N #}
                {% for i in range(0, max_materiais) %}
                  <td data-col="valor_unitario_{{ i+1 }}">
                    {% if e.materiais and e.materiais|length > i and e.materiais[i].valor_unitario is not none %}
                      {{ e.materiais[i].valor_unitario|money }}
                    {% endif %}
                  </td>
                {% endfor %}

                {# Duplicatas 1..N #}
                {% for j in range(0, max_duplicatas) %}
                  <td data-col="duplicata_{{ j+1 }}">
                    {% if e.duplicatas and e.duplicatas|length > j and e.duplicatas[j] is not none %}
                      {{ e.duplicatas[j]|money }}
                    {% endif %}
                  </td>
                {% endfor %}

                {# √öltimas colunas #}
                <td data-col="valor_unitario_energia">{{ e.valor_unitario_energia|money }}</td>
                <td data-col="valor_mao_obra_tm_metallica">{{ e.valor_mao_obra_tm_metallica|money }}</td>
                <td data-col="peso_liquido">{{ e.peso_liquido|peso }}</td>
                <td data-col="peso_integral">{{ e.peso_integral|peso }}</td>

                <td class="acoes" data-col="acoes">
                  <button class="btn-acao btn-editar" data-id="{{ e.id }}">‚úèÔ∏è</button>
                  <button class="btn-acao btn-excluir" data-id="{{ e.id }}">üóëÔ∏è</button>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="{{ 13 + (max_materiais * 2) + max_duplicatas }}" class="no-data">
                  Nenhuma entrada encontrada.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal de Importa√ß√£o Excel (Entrada NF) -->
    <div id="modal-import-entrada" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Importar Excel ‚Äî Entradas</h3>
          <button id="importClose" class="close" type="button">&times;</button>
        </div>

        <form id="form-import-excel" action="/entrada_nf/importar_excel" method="post" enctype="multipart/form-data">
          <div class="modal-body">
            <p>Selecione o arquivo Excel (.xls ou .xlsx). Colunas esperadas: <strong>Data, NF, Fornecedor, Produto, Custo Empresa, IPI, Valor Integral</strong>.</p>

            <div>
              <label for="arquivo_excel">Arquivo Excel</label>
              <input type="file" name="arquivo_excel" id="arquivo_excel"
                    accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
            </div>

            <div id="progressContainer" style="display:none; margin-top:10px;">
              <div style="background:#eee; height:12px; width:100%; border-radius:6px; overflow:hidden;">
                <div id="progressBar" style="width:0%; height:100%;"></div>
              </div>
              <div id="progressText" style="margin-top:6px;">0%</div>
            </div>

            <div id="importMessage" style="display:none; margin-top:10px;">
              <div id="importMsgText"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" id="cancelImport" class="btn">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="pagination">
      {% if page > 1 %}
        <a href="#" class="page-btn" data-page="1">¬´ Primeiro</a>
        <a href="#" class="page-btn" data-page="{{ page-1 }}">‚Üê Anterior</a>
      {% endif %}
      {% for p in range(1, total_pages+1) %}
        {% if p == page %}
          <span class="current">{{ p }}</span>
        {% else %}
          <a href="#" class="page-btn" data-page="{{ p }}">{{ p }}</a>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
        <a href="#" class="page-btn" data-page="{{ page+1 }}">Pr√≥ximo ‚Üí</a>
        <a href="#" class="page-btn" data-page="{{ total_pages }}">√öltimo ¬ª</a>
      {% endif %}
    </div>

  </div>
</div>