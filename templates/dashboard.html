<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='logos/Kametal.ico') }}" type="image/x-icon" />
</head>
<body>
  <aside class="sidebar collapsed" id="sidebar">
    <nav class="menu">
      <a href="{{ url_for('usuarios.usuarios') }}" class="menu-item {% if request.endpoint=='usuarios' %}active{% endif %}">
        <span class="icon">üë•</span><span class="label">Usu√°rios</span>
      </a>

      <div class="menu-item has-submenu" id="reportsItem">
        <span class="icon">üõ†Ô∏è</span>
        <span class="label">Base de Material/Produto</span>
      </div>
      <ul class="submenu hidden" id="reportsSubmenu">
        <li>
          <a href="{{ url_for('materiais.materiais') }}" class="{% if request.endpoint=='materiais' %}active{% endif %}">
            <span class="sub-icon">üß±</span>
            <span class="sub-label">Base Material</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('produtos.produtos') }}" class="{% if request.endpoint == 'produtos' %}active{% endif %}">
            <span class="sub-icon">üì¶</span>
            <span class="sub-label">Base Produto</span>
          </a>
        </li>
      </ul>

      <div class="menu-item has-submenu" id="nfItem">
        <span class="icon">üìÑ</span>
        <span class="label">Nota Fiscal</span>
      </div>
      <ul class="submenu hidden" id="nfSubmenu">
        <li>
          <a href="{{ url_for('entrada_nf.nova_entrada') }}" class="">
            <span class="sub-icon">‚¨áÔ∏èüìÑ</span>
            <span class="sub-label">Entrada Nota Fiscal</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('saida_nf.saida_nf') }}" class="sub-item">
            <span class="sub-icon">‚¨ÜÔ∏èüìÑ</span>
            <span class="sub-label">Sa√≠da Nota Fiscal</span>
          </a>
        </li>
      </ul>

      <div class="menu-item has-submenu" id="calculosItem">
        <span class="icon">üßÆ</span>
        <span class="label">C√°lculos e M√©dias</span>
      </div>
      <ul class="submenu hidden" id="calculosSubmenu">
        <li>
          <a href="#" class="{% if request.endpoint=='calculos.calculos_nfs' %}active{% endif %}">
            <span class="sub-icon">üìä</span>
            <span class="sub-label">C√°lculos de NFs</span>
          </a>
        </li>
        <li>
          <a href="#" class="{% if request.endpoint=='calculos.media_custo' %}active{% endif %}">
            <span class="sub-icon">üî¢</span>
            <span class="sub-label">M√©dia de Custo</span>
          </a>
        </li>
      </ul>
      <a href="#" class="menu-item"><span class="icon">üìã</span><span class="label">Relat√≥rios</span></a>
      <a href="#" class="menu-item"><span class="icon">üìà</span><span class="label">Graficos de Cota√ß√£o</span></a>
    </nav>
  </aside>

  <div class="main">
    <header class="header">
      <div class="header-left">
        <button id="toggleSidebar" class="toggle-btn">‚ò∞</button>
      </div>
      <div class="header-center">
        <div class="logo-title">
          <img src="{{ url_for('static', filename='logos/Kametal.png') }}" alt="Logo" />
          <h1>SistemaX</h1>
        </div>
      </div>
      <div class="header-right">
        <div class="user-menu" id="userMenu">
          <span class="user-name">üë§ {{ nome_usuario }}</span>
          <ul class="dropdown" id="userDropdown">
            <li><a href="#">Perfil</a></li>
            <li><a href="{{ url_for('auth.logout') }}">Sair</a></li>
          </ul>
        </div>
      </div>
    </header>

    <section class="content">
      <div class="tabs-nav">
        <button class="tab-btn active" data-tab="aba1">Materiais/Produtos</button>
        <button class="tab-btn" data-tab="aba2">Relatorio Saida NFs</button>
        <button class="tab-btn" data-tab="aba3">Relat√≥rio de Entrada NFs</button>
        <button class="tab-btn" data-tab="aba4">Alertas</button>
        <button class="tab-btn" data-tab="aba6">Configura√ß√µes</button>
        <span class="tab-indicator"></span>
      </div>

      <div class="tabs-content">
        <div class="tab-content active" id="aba1">
          <h2>Relat√≥rio de Materiais</h2>
          <div class="report-frame" id="mat-frame">
            {% if materiais %}
            <table class="report-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Fornecedor</th>
                  <th>Valor</th>
                  <th>Grupo</th>
                </tr>
              </thead>
              <tbody>
                {% for _, nome, fornecedor, valor, grupo in materiais %}
                <tr>
                  <td>{{ nome }}</td>
                  <td>{{ fornecedor }}</td>
                  <td class="right">
                    {{ "{:,.4f}".format(valor).replace(',', '_').replace('.', ',').replace('_', '.') }}
                  </td>
                  <td>{{ grupo }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="no-items-msg">Nenhum material cadastrado.</p>
            {% endif %}
          </div>

          <h2>Relat√≥rio de Produtos</h2>
          <div class="report-frame" id="prod-frame">
            {% if produtos %}
            <table class="report-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>% Cobre</th>
                  <th>% Zinco</th>
                </tr>
              </thead>
              <tbody>
                {% for nome, pc, pz in produtos %}
                <tr>
                  <td>{{ nome }}</td>
                  <td class="center">
                    {{ "{:,.2f}".format(pc).replace(",", "_").replace(".", ",").replace("_", ".") }}%
                  </td>
                  <td class="center">
                    {{ "{:,.2f}".format(pz).replace(",", "_").replace(".", ",").replace("_", ".") }}%
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="no-items-msg">Nenhum produto cadastrado.</p>
            {% endif %}
          </div>
        </div>

        <div class="tab-content" id="aba2">
          <!-- T√≠tulo fora do card -->
          <h2>√öltimas Sa√≠das de NFs</h2>
          <div class="card report-card mb-4">
            <div class="card-body p-0">
              <div class="table-responsive report-table" id="saida-nf-frame">
                <table class="table mb-0">
                  <colgroup>
                    <col style="width: 90px">
                    <col style="width: 60px">
                    <col style="width: 200px">
                    <col style="width: 80px">
                    <col style="width: 180px">
                    <col style="width: 120px">
                  </colgroup>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>NF</th>
                      <th>Produto</th>
                      <th class="text-right">Peso</th>
                      <th>Cliente</th>
                      <th>Base Produto</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if ultimas_saidas %}
                      {% for nf in ultimas_saidas %}
                        {# cria um √≠ndice reutiliz√°vel para cada NF #}
                        {% set nf_idx = loop.index0 %}

                        <!-- Linha PAI - NF -->
                        <tr class="nf-row" data-nf="{{ nf_idx }}">
                          <td class="nf-toggle">
                            <button class="nf-btn" type="button" aria-expanded="false" data-nf="{{ nf_idx }}">
                              <span class="chev">‚ñ∂</span>
                              <span class="nf-date">{{ nf.data }}</span>
                            </button>
                          </td>

                          <td class="nf-number">
                            <strong>{{ nf.nf }}</strong>
                            <!-- badge mostra "N itens" e title lista os produtos -->
                            <span
                              class="count-badge"
                              title="{{ nf.products|map(attribute='produto')|join(' ‚Äî ') }}"
                              aria-label="{{ nf.products|length }} itens">
                              {{ nf.products|length }} {{ 'item' if nf.products|length == 1 else 'itens' }}
                            </span>
                          </td>

                          <td class="nf-summary">
                            <strong>{{ nf.products[0].produto }}</strong>
                            {% if nf.products|length > 1 %}
                              <span class="muted">e mais {{ nf.products|length - 1 }} {{ 'produto' if (nf.products|length - 1) == 1 else 'produtos' }}</span>
                            {% endif %}
                          </td>

                          <!-- Deixa bem claro que √© o PESO TOTAL da NF -->
                          <td class="text-right nf-total-peso">
                            <div class="total-label">Total</div>
                            <div class="total-value">{{ nf.total_peso }}</div>
                          </td>

                          <td class="nf-client">{{ nf.cliente }}</td>
                          <td class="nf-base">{{ nf.base }}</td>
                        </tr>

                        <!-- Linhas FILHAS - produtos da NF (usando nf_idx) -->
                        {% for prod in nf.products %}
                        <tr class="product-row hidden" data-nf="{{ nf_idx }}">
                          <td></td>
                          <td></td>
                          <td class="product-name">‚Ä¢ {{ prod.produto }}</td>
                          <td class="text-right">{{ prod.peso }}</td>
                          <td colspan="2"></td>
                        </tr>
                        {% endfor %}
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="6" class="text-center py-3">
                          Nenhuma sa√≠da de NF encontrada.
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="aba3">
          <h2>√öltima Entrada NFs</h2>

          <div class="card report-card mb-4">
            <div class="card-body p-0">
              <div class="table-responsive report-table" id="ultima-entrada-frame">
                <table class="table mb-0">
                  <colgroup>
                    <col style="width:120px">
                    <col style="width:80px">
                    <col style="width:220px">
                    <col style="width:200px">
                    <col style="width:120px">
                  </colgroup>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>NF</th>
                      <th>Fornecedor</th>
                      <th class="text-center">Produto</th>
                      <th class="text-center">Peso L√≠q.</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if ultima_entrada %}
                    <tr>
                      <td>{{ ultima_entrada.data }}</td>
                      <td>{{ ultima_entrada.nf }}</td>
                      <td>{{ ultima_entrada.fornecedor }}</td>
                      <td class="text-center">{{ ultima_entrada.produto }}</td>
                      <td class="text-center">{{ ultima_entrada.peso_liquido }}</td>
                    </tr>
                    {% else %}
                    <tr>
                      <td colspan="5" class="text-center py-3">
                        Nenhuma entrada encontrada.
                      </td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="aba4">
          <h2>Alertas</h2>
          <ul class="alert-list"></ul>
        </div>

        <div class="tab-content" id="aba6">
          <h2>Configura√ß√µes</h2>
          <form class="settings-form"></form>
        </div>
      </div>
    </section>
  </div>

  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>
